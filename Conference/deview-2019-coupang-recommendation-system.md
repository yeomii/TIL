# 쿠팡 추천시스템 변천사
* https://deview.kr/2019/schedule/276

## 추천 플랫폼의 변화
* 하고 있는 일 - 상품 추천
    * item 과 item 간의 관계 학습
    * 함께 본 대체재 또는 함께 산 대체제
* 하고 싶은 일
    * 특정 상품이 컨텍스트가 아닌 추천
        * 유저 컨텍스트 / 카테고리 컨텍스트 등
    * weight / filter
    * 추천영역 / ui 도 개인화
* feature
    * 모델 점수 -> 모델 점수들 + 개인화 등

## 과거: 추천 모델 중심의 플랫폼
* 모델과 서비스가 강결합 되어있는 구조
* 한계
    * 모델 변경에 따라 길어지는 파이프라인
    * 추가 요청사항을 처리하기 어려움
    * 완성 전까지 결과를 알 수 없음
    * 개발 소요 시간이 큼
    * 서빙시에 유저 정보 접근이 어려웠음
    * 점진적인 개선이 어려움
    * 모델의 재활용이 어려움
* 목표
    * 추천 모델과 서비스를 분리시킬 것
    * 상품 정보나 유저 정보가 서빙시에 접근 가능할 것
    * 필터, 부스팅 등 변경이 쉽고 빠를 것

## 현재: 서비스와 모델을 분리하는 플랫폼
* 검색 플랫폼으로 추천 시스템 이관
* 중앙화된 상품 정보
    * spark, hive, tf -> 상품을 잘 표현하는 feature 를 만든다
    * 만들어진 feature 는 ProtoBuf 를 사용해서 hbase 에 저장
    * 인덱싱은 검색과 추천 조직이 따로 관리
* feature
    * 연관성 feature
        * 이미지 유사도
        * 카테고리 관련성
    * 상품 자체 피처
* 상품에 대한 정보를 그대로 올려두는 in-memory 스토리지 - proto
* search cluster
    * 컨텍스트와 관련된 상품을 찾고
    * 조건에 따라 필터 한 후
    * 점수에 따라 정렬
* query handler cluster
    * 서비스 정의
        * query - 대체제, 보완재 등
        * filter - 카테고리 등
        * boost - 할인율 등
    * 추가 정렬
        * 필요할 경우 비즈니스적 조건에 따라 새롭게 정렬 가능
* 모델과 서비스의 분리
    * 서비스 - 있는 피처들을 어떻게 쓸지 고민
    * 모델 개발, 피처 생성 - 좋은 피처를 만들기 위해 노력
* 

## 더나은 추천을 위해
* 쿼리 튜닝
### learning to rank
* 쿼리 튜닝을 모델에게 맡기자
* inference
    * search cluster 각 노드는 모델을 들고 각자의 추천 후보상품을 리랭킹
    * 모델 결과가 이상한 것은 리뷰나 ctr 로 보정
* training
    * 당시에 어떤 파라미터를 가지고 있었는지 실시간 로깅
    * 새로운 피처는 쿼리를 재현하여 crawl
    * 유저 피드백 backfill
* 모델을 위한 피처 엔지니어링
    * 모델이 잘 사용할 수 있는 피처를 만드는 것이 중요

### 실시간 개인화
* 실시간 사용자 피처
    * 실시간 사용자 행동 정보 -> kafka -> redis
* 오프라인 사용자 피처
    * 사용자 분석 모델 - 카테고리 / 가격대 / 브랜드 선호 등
* 유저 상품 연관성
* 세그먼트 상품 연관성
* 유저 세그먼트 
    * recency
    * frequency
    * monetary
    * device
    * parent
    * car owner
    * gender
* 실시간 상품 피처
    * 실시간 로그 -> redis -> 각 search cluster 노드
    * near-realtime 으로 들고있음
* 실시간 개인화
    * 상품 연관성 피처 + 상품 피처 + 사용자 연관성 피처 + 사용자 피처
* 추천 영역 개인화 
    * 사용자 피처 + 추천 영역 선호도
* feature selection (+ 사용하는 피처 수를 적게 유지하려고 노력)
    * 피처가 어떻게 작동하는가
    * 어떤 피처를 우선적으로 개선해야 하는가
    * 모델을 어떻게 디버깅하고 개선해야 하는가
    * 피처 사이의 관련성 및 값의 분포 확인 필요

## 팁
* LTR 모델 - 복잡 vs 단순
    * 복잡 - RNN / CNN, 단순 - Decision tree / MLP
    * 쿠팡에서는 단순한 모델 사용
    * feature engineering 에 더 집중
    * recall 을 높이는 것은 추천 영역에는 맞지 않다고 생각
* 피처 엔지니어링 vs 파라미터 튜닝
    * 피처 엔지니어링이 이터레이션을 거치면서 더 도움이 된다고 생각